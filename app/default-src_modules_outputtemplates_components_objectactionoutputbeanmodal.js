/*!
 * 
 *                     aacService
 *
 *                     release: 2023.02.001
 *
 *                     date: 2023-11-19 12:43:46
 *
 *                     build: 2023.02.001.1700397826672
 *
 */
"use strict";(self.webpackChunkcore=self.webpackChunkcore||[]).push([["default-src_modules_outputtemplates_components_objectactionoutputbeanmodal_ts"],{2486:(t,e,s)=>{s.d(e,{s:()=>F});var l=s(2242),i=s(2294),a=s(1591),n=s(2198),o=s(3507),d=s(5329),c=s(5710),m=s(4154),r=s(4044),u=s(4505),p=s(6550),h=s(6163),f=s(4755),g=s(5030),b=s(8861),_=s(2656),x=s(3463),v=s(9621),w=s(3499),A=s(5767),T=s(1916),Z=s(4664);function y(t,e){if(1&t&&(l.TgZ(0,"option",30),l._uU(1),l.qZA()),2&t){const t=e.$implicit;l.Q6J("ngValue",t),l.xp6(1),l.AsE("",t.name," (",t.language,")")}}function B(t,e){if(1&t){const t=l.EpF();l.ynx(0),l.TgZ(1,"div",31)(2,"label",6),l._UZ(3,"system-label",32),l.qZA(),l.TgZ(4,"div",8)(5,"div",9)(6,"select",10),l.NdJ("ngModelChange",(function(e){l.CHM(t);const s=l.oxw();return l.KtG(s.selected_format=e)})),l.TgZ(7,"option",33),l._uU(8,"HTML"),l.qZA(),l.TgZ(9,"option",34),l._uU(10,"PDF"),l.qZA()()()()(),l.BQk()}if(2&t){const t=l.oxw();l.xp6(6),l.Q6J("ngModel",t.selected_format)("disabled",0==t.templates.length)}}const M=function(t){return{"slds-is-selected":t}};function O(t,e){if(1&t){const t=l.EpF();l.TgZ(0,"button",35),l.NdJ("click",(function(){l.CHM(t);const e=l.oxw();return l.KtG(e.openEmailArea())})),l._UZ(1,"system-button-icon",36),l.qZA()}if(2&t){const t=l.oxw();l.Q6J("disabled",!t.selected_template||t.loading_output||"html"===t.selected_format)("ngClass",l.VKq(2,M,t.expanded))}}function L(t,e){if(1&t&&l._UZ(0,"iframe",37),2&t){const t=l.oxw();l.Q6J("srcdoc",t.sanitizedTemplated,l.oJD)}}function E(t,e){if(1&t&&l._UZ(0,"object",38),2&t){const t=l.oxw();l.Q6J("data",t.blobUrl,l.uOi)}}function J(t,e){1&t&&(l.TgZ(0,"div",39),l._UZ(1,"system-spinner"),l.qZA())}function k(t,e){1&t&&(l.TgZ(0,"div",39),l._UZ(1,"system-label",40),l.qZA())}function C(t,e){if(1&t){const t=l.EpF();l.TgZ(0,"object-action-output-bean-modal-email-content",41,42),l.NdJ("email_sent",(function(){l.CHM(t);const e=l.oxw();return l.KtG(e.emailSent())})),l.qZA()}if(2&t){const t=l.oxw();l.Q6J("fieldset",t.fieldset_email)("filelist",t.filelist)("parent",t.model)}}function I(t,e){if(1&t){const t=l.EpF();l.TgZ(0,"button",43),l.NdJ("click",(function(){l.CHM(t);const e=l.oxw();return l.KtG(e.create())})),l._uU(1),l.qZA()}if(2&t){const t=l.oxw();l.Q6J("disabled",!t.selected_template||t.loading_output),l.xp6(1),l.Oqu(t.buttonText)}}function U(t,e){if(1&t){const t=l.EpF();l.TgZ(0,"button",43),l.NdJ("click",(function(){l.CHM(t);const e=l.oxw();return l.KtG(e.sendEmail())})),l._uU(1),l.qZA()}if(2&t){const t=l.oxw();l.Q6J("disabled",!t.selected_template||t.loading_output||!t.canSend),l.xp6(1),l.Oqu(t.language.getLabel("LBL_SENDEMAIL"))}}let F=(()=>{class ObjectActionOutputBeanModal{language;model;metadata;modal;view;backend;outputModalService;sanitizer;viewContainerRef;modelutilities;emailContent;actionemitter=new l.vpe;modalTitle;forcedFormat;noDownload=!1;handBack;buttonText;contentForHandBack;liveCompile=!1;customActionsetId;self=void 0;templates=[];_selected_template=null;_selected_format="pdf";compiled_selected_template="";loading_output=!1;fieldset_email="";file;filelist=[];showsendemail=!1;expanded=!1;emailInitialized=!1;blobUrl;constructor(t,e,s,l,i,a,n,o,d,c){this.language=t,this.model=e,this.metadata=s,this.modal=l,this.view=i,this.backend=a,this.outputModalService=n,this.sanitizer=o,this.viewContainerRef=d,this.modelutilities=c;let m=this.metadata.getComponentConfig("ObjectActionOutputBeanModal");this.fieldset_email=m.fieldset_email}ngOnInit(){this.setModalData(),this.setSelectedTemplate(),this.selected_template||1!=this.templates.length||(this.selected_template=this.templates[0])}setModalData(){this.modalTitle||(this.modalTitle=this.language.getLabel(this.language.getLabel("LBL_OUTPUT_TEMPLATE"))),this.buttonText||(this.buttonText=this.language.getLabel(this.noDownload?"LBL_OK":"LBL_DOWNLOAD")),this.forcedFormat&&(this._selected_format=this.forcedFormat)}setSelectedTemplate(){let t=this.metadata.getModuleFields(this.model.module);for(let e in t)if("relate"==t[e].type&&"OutputTemplates"==t[e].module){let s=this.templates.find((s=>s.id==this.model.getFieldValue(t[e].id_name)));s&&(this.selected_template=s);break}}set selected_template(t){this._selected_template=t,this.outputModalService.selectedTemplate=t,this.rendertemplate()}get selected_template(){return this._selected_template}get selected_format(){return this._selected_format}set selected_format(t){this._selected_format=t,this.expanded=!1,this.rendertemplate()}get sanitizedTemplated(){return this.sanitizer.bypassSecurityTrustHtml(this.compiled_selected_template)}rendertemplate(){switch(this.loading_output=!0,this.blobUrl=null,this.compiled_selected_template=null,this.selected_format){case"pdf":const t={bean_data:this.liveCompile?this.modelutilities.spiceModel2backend(this.model.module,this.model.data):null};this.backend.postRequest(`module/OutputTemplates/${this.selected_template.id}/convert/${this.model.id}/to/pdf/base64`,null,t).subscribe({next:t=>{let e=this.datatoBlob(atob(t.content),"application/pdf");this.blobUrl=this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(e)),this.contentForHandBack=t.content,this.setEmailAttachmentData(),this.loading_output=!1},error:()=>{this.loading_output=!1}});break;case"html":this.backend.getRequest(`module/OutputTemplates/${this.selected_template.id}/compile/${this.model.id}`).subscribe({next:t=>{this.compiled_selected_template=t.content,this.contentForHandBack=t.content,this.setEmailAttachmentData(),this.loading_output=!1},error:()=>{this.loading_output=!1}})}}reload(){this.rendertemplate()}close(){this.outputModalService.modalResponse$.next("close"),this.outputModalService.modalResponse$.complete(),this.self.destroy()}create(){if(this.handBack&&this.handBack.emit({name:this.selected_template.name,content:this.contentForHandBack}),this.noDownload)this.close();else{let t=document.createElement("a");document.body.appendChild(t);let e=this.datatoBlob("pdf"==this.selected_format?atob(this.contentForHandBack):this.contentForHandBack);t.href=URL.createObjectURL(e),t.type="pdf"==this.selected_format?"application/pdf":"text/html",t.download=this.model.module+"_"+this.model.getField("summary_text")+"."+this.selected_format,t.click(),t.remove()}}set data(t){let e=this.datatoBlob(t);this.blobUrl=this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(e))}datatoBlob(t,e="",s=512){let l=[];for(let e=0;e<t.length;e+=s){let i=t.slice(e,e+s),a=new Array(i.length);for(let t=0;t<i.length;t++)a[t]=i.charCodeAt(t);let n=new Uint8Array(a);l.push(n)}return new Blob(l,{type:e})}openEmailArea(){this.emailInitialized||(this.emailInitialized=!0,this.setEmailAttachmentData()),this.expanded=!this.expanded}setEmailAttachmentData(){this.emailInitialized&&(this.filelist=[{size:this.contentForHandBack.length,name:this.model.module+"_"+this.model.getField("summary_text")+"."+this.selected_format,type:"application/"+this.selected_format,filecontent:this.contentForHandBack}])}emailSent(){this.close()}get canSend(){return this.emailContent&&!this.emailContent.disabled}sendEmail(){"Letters"==this.model.module&&this.backend.postRequest(`module/Letters/${this.model.id}/marksent/${this.selected_template.id}`,null,this.model.data).subscribe((t=>{this.actionemitter.emit({close:!0,name:"sent"})})),this.emailContent.sendEmail()}handleAction(t){this.outputModalService.modalResponse$.next(t.name),t.close&&(this.model.cancelEdit(),this.close())}static ɵfac=function(t){return new(t||ObjectActionOutputBeanModal)(l.Y36(d.d),l.Y36(c.o),l.Y36(m.Pu),l.Y36(r.o),l.Y36(i.e),l.Y36(u.y),l.Y36(o.w),l.Y36(p.H7),l.Y36(l.s_b),l.Y36(h.A))};static ɵcmp=l.Xpm({type:ObjectActionOutputBeanModal,selectors:[["object-action-output-bean-modal"]],viewQuery:function(t,e){if(1&t&&l.Gf(n.N,5),2&t){let t;l.iGM(t=l.CRH())&&(e.emailContent=t.first)}},outputs:{actionemitter:"actionemitter"},features:[l._Bn([i.e,o.w])],decls:34,vars:17,consts:[["size","large"],[3,"close"],["margin","none"],[1,"slds-modal__content"],[1,"slds-grid","slds-p-horizontal--x-small","slds-p-top--x-small"],[1,"slds-form-element","slds-grid","slds-grow"],[1,"slds-form-element__label"],["label","LBL_TEMPLATE"],[1,"slds-form-element__control","slds-grow"],[1,"slds-select_container"],[1,"slds-select",3,"ngModel","disabled","ngModelChange"],[3,"ngValue",4,"ngFor","ngForOf"],[4,"ngIf"],["class","slds-button slds-button--icon slds-button--icon-border slds-m-left--small",3,"disabled","ngClass","click",4,"ngIf"],[1,"slds-grid",2,"height","70vh"],[1,"slds-p-around--small",2,"height","100%","width","200%"],[1,"slds-m-top--small","slds-border--top","slds-border--right","slds-border--left","slds-border--bottom",2,"width","100%","height","calc(100% - 50px)"],["frameBorder","0","style","width: 100%;height: 100%;",3,"srcdoc",4,"ngIf"],["type","application/pdf","width","100%","height","100%",3,"data",4,"ngIf"],["class","slds-align--absolute-center","style","height: 100%;",4,"ngIf"],[1,"slds-scrollable",2,"height","100%"],[3,"fieldset","filelist","parent","email_sent",4,"ngIf"],[1,"slds-grid","slds-grid--vertical-align-center","slds-grid--align-end"],["role","group",1,"slds-button-group"],[1,"slds-button","slds-button--neutral",3,"click"],["label","LBL_CANCEL"],[1,"slds-button","slds-button--neutral",3,"disabled","click"],["label","LBL_RELOAD"],["class","slds-button slds-button--brand",3,"disabled","click",4,"ngIf"],["containerclass","slds-button-group",1,"slds-m-left--x-small",2,"display","inline-flex",3,"actionset","actionemitter"],[3,"ngValue"],[1,"slds-form-element","slds-grid","slds-grow","slds-m-left--x-small"],["label","LBL_DISPLAY"],["value","html"],["value","pdf"],[1,"slds-button","slds-button--icon","slds-button--icon-border","slds-m-left--small",3,"disabled","ngClass","click"],["icon","email"],["frameBorder","0",2,"width","100%","height","100%",3,"srcdoc"],["type","application/pdf","width","100%","height","100%",3,"data"],[1,"slds-align--absolute-center",2,"height","100%"],["label","LBL_SELECT_TEMPLATE"],[3,"fieldset","filelist","parent","email_sent"],["emailcontent",""],[1,"slds-button","slds-button--brand",3,"disabled","click"]],template:function(t,e){1&t&&(l.TgZ(0,"system-modal",0)(1,"system-modal-header",1),l.NdJ("close",(function(){return e.close()})),l._uU(2),l.qZA(),l.TgZ(3,"system-modal-content",2)(4,"div",3)(5,"div",4)(6,"div",5)(7,"label",6),l._UZ(8,"system-label",7),l.qZA(),l.TgZ(9,"div",8)(10,"div",9)(11,"select",10),l.NdJ("ngModelChange",(function(t){return e.selected_template=t})),l.YNc(12,y,2,3,"option",11),l.qZA()()()(),l.YNc(13,B,11,2,"ng-container",12),l.YNc(14,O,2,4,"button",13),l.qZA(),l.TgZ(15,"div",14)(16,"div",15)(17,"div",16),l.YNc(18,L,1,1,"iframe",17),l.YNc(19,E,1,1,"object",18),l.YNc(20,J,2,0,"div",19),l.YNc(21,k,2,0,"div",19),l.qZA()(),l.TgZ(22,"div",20),l.YNc(23,C,2,3,"object-action-output-bean-modal-email-content",21),l.qZA()()()(),l.TgZ(24,"system-modal-footer")(25,"div",22)(26,"div",23)(27,"button",24),l.NdJ("click",(function(){return e.close()})),l._UZ(28,"system-label",25),l.qZA(),l.TgZ(29,"button",26),l.NdJ("click",(function(){return e.reload()})),l._UZ(30,"system-label",27),l.qZA(),l.YNc(31,I,2,2,"button",28),l.YNc(32,U,2,2,"button",28),l.qZA(),l.TgZ(33,"object-action-container",29),l.NdJ("actionemitter",(function(t){return e.handleAction(t)})),l.qZA()()()()),2&t&&(l.xp6(2),l.Oqu(e.modalTitle),l.xp6(9),l.Q6J("ngModel",e.selected_template)("disabled",0==e.templates.length),l.xp6(1),l.Q6J("ngForOf",e.templates),l.xp6(1),l.Q6J("ngIf",!e.forcedFormat),l.xp6(1),l.Q6J("ngIf",e.metadata.checkModuleAcl("Emails","create")),l.xp6(2),l.Q6J("@slideInOut",e.expanded?"open":"closed"),l.xp6(2),l.Q6J("ngIf","html"===e.selected_format&&!e.loading_output&&e.selected_template),l.xp6(1),l.Q6J("ngIf","pdf"===e.selected_format&&!e.loading_output&&e.blobUrl),l.xp6(1),l.Q6J("ngIf",e.loading_output),l.xp6(1),l.Q6J("ngIf",!e.selected_template&&!e.loading_output),l.xp6(1),l.Q6J("@slideInOut2",e.expanded?"open":"closed"),l.xp6(1),l.Q6J("ngIf",e.emailInitialized),l.xp6(6),l.Q6J("disabled",!e.selected_template||e.loading_output),l.xp6(2),l.Q6J("ngIf",!e.expanded),l.xp6(1),l.Q6J("ngIf",e.expanded),l.xp6(1),l.Q6J("actionset",e.customActionsetId))},dependencies:[f.mk,f.sg,f.O5,g.YN,g.Kr,g.EJ,g.JJ,g.On,b.S,_.J,x._,v.j,w.x,A.p,T.y,Z.W,n.N],encapsulation:2,data:{animation:[(0,a.X$)("slideInOut",[(0,a.SB)("open",(0,a.oB)({width:"50%"})),(0,a.SB)("closed",(0,a.oB)({width:"100%"})),(0,a.eR)("open <=> closed",[(0,a.jt)("200ms")])]),(0,a.X$)("slideInOut2",[(0,a.SB)("open",(0,a.oB)({width:"50%"})),(0,a.SB)("closed",(0,a.oB)({width:"0%"})),(0,a.eR)("open <=> closed",[(0,a.jt)("200ms")])])]}})}return ObjectActionOutputBeanModal})()},2198:(t,e,s)=>{s.d(e,{N:()=>p});var l=s(2242),i=s(5710),a=s(2294),n=s(5329),o=s(4154),d=s(4044),c=s(5920),m=s(9062),r=s(2995);const u=function(t){return{uploadfiles:t}};let p=(()=>{class ObjectActionOutputBeanModalEmailContent{language;model;metadata;modal;view;session;fieldset=null;filelist={};attachmentContent;parent={};email_sent=new l.vpe;attachmentsPanelRef;sending=!1;constructor(t,e,s,l,i,a){this.language=t,this.model=e,this.metadata=s,this.modal=l,this.view=i,this.session=a}ngOnInit(){this.setModelData(),this.setViewData()}ngOnChanges(t){t.filelist&&this.attachmentsPanelRef&&this.attachmentsPanelRef.instance.setUploadFiles(this.filelist)}setModelData(){this.model.module="Emails",this.model.initialize(this.parent);let t={};t.parent_type=this.parent.module,t.parent_id=this.parent.data.id,t.parent_name=this.parent.data.name,t.isNew=!0,t.assigned_user_id=this.session.authData.userId,t.assigned_user_name=this.session.authData.userName,t.modified_by_id=this.session.authData.userId,t.modified_by_name=this.session.authData.userName,t.date_entered=new Date,t.date_modified=new Date,this.model.setFields(t),this.model.startEdit()}setViewData(){this.view.setEditMode(),this.view.isEditable=!0}get disabled(){let t=this.model.getFieldValue("recipient_addresses"),e=this.model.getFieldValue("mailbox_id"),s=this.model.getFieldValue("name"),l=t?t.find((t=>"to"==t.address_type)):void 0;return!(s&&e&&t&&l)||this.sending}sendEmail(){this.modal.openModal("SystemLoadingModal",!1).subscribe((t=>{t.instance.messagelabel="LBL_SENDING",this.sending=!0,this.model.setFields({type:"out",to_be_sent:"1",from_addr:this.model.getField("from_addr_name"),to_addrs:this.model.getField("to_addrs_names")}),this.model.save().subscribe((e=>{t.instance.self.destroy(),this.email_sent.emit()}),(e=>{t.instance.self.destroy(),this.sending=!1}))}))}static ɵfac=function(t){return new(t||ObjectActionOutputBeanModalEmailContent)(l.Y36(n.d),l.Y36(i.o),l.Y36(o.Pu),l.Y36(d.o),l.Y36(a.e),l.Y36(c.n))};static ɵcmp=l.Xpm({type:ObjectActionOutputBeanModalEmailContent,selectors:[["object-action-output-bean-modal-email-content"]],inputs:{fieldset:"fieldset",filelist:"filelist",attachmentContent:"attachmentContent",parent:"parent"},outputs:{email_sent:"email_sent"},features:[l._Bn([a.e,i.o]),l.TTD],decls:2,vars:4,consts:[["direction","vertical",3,"fieldset"],["component","SpiceAttachmentsPanel",3,"componentattributes","componentref"]],template:function(t,e){1&t&&(l._UZ(0,"object-record-fieldset",0),l.TgZ(1,"system-dynamic-component",1),l.NdJ("componentref",(function(t){return e.attachmentsPanelRef=t})),l.qZA()),2&t&&(l.Q6J("fieldset",e.fieldset),l.xp6(1),l.Q6J("componentattributes",l.VKq(2,u,e.filelist)))},dependencies:[m.d,r.T],encapsulation:2})}return ObjectActionOutputBeanModalEmailContent})()},3507:(t,e,s)=>{s.d(e,{w:()=>i});var l=s(2242);let i=(()=>{class outputModalService{selectedTemplate;modalResponse$=new l.vpe;static ɵfac=function(t){return new(t||outputModalService)};static ɵprov=l.Yz7({token:outputModalService,factory:outputModalService.ɵfac})}return outputModalService})()}}]);